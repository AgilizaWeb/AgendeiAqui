<!-- <link rel="stylesheet" type="text/css" href="https://teste.vipconnect.top/lib/datatables/css/jquery.dataTables.css" /> -->
<link rel="stylesheet" type="text/css" href="/css/bootstrap/datatables.css" />
<!-- <link rel="stylesheet" type="text/css" href="https://teste.vipconnect.top/lib/select2/css/select2.min.css" /> -->
<link rel="stylesheet" type="text/css" href="/css/bootstrap/select2.css" />
<!-- <link rel="stylesheet" type="text/css" href="https://teste.vipconnect.top/css/slim.css" /> -->
<link rel="stylesheet" type="text/css" href="/css/bootstrap/slim.css" />

<form onsubmit="handle_plano(event)" id="add_plano-bg"
  class="fixed z-50 w-full h-screen hidden flex-col justify-center items-center gap-1 bg-[#00000096]">

  <div class="w-full xl:w-1/2 h-full relative flex justify-center items-center">
    <div
      class="bg-zinc-100 dark:bg-black p-4 rounded max-xss:w-full w-[90%] sm:w-[60%] max-h-[99vh] overflow-auto animate-slideBottomToTop">
      <h1 id="add_plano-title" class="w-full mb-3 font-bold flex">Adicionar Plano</h1>

      <div id="bg-test">
        <%- include('../includes/dashboard/components/input_text.ejs', { id: 'add_plano-nome' ,
          icon: 'fi fi-rs-pen-field' , placeholder: 'Nome' }) %>
          <%- include('../includes/dashboard/components/input_text.ejs', { id: 'add_plano-descricao' ,
            icon: 'fi fi-rs-pen-field' , placeholder: 'Descrição' }) %>
            <%#- include('../includes/dashboard/components/input_text.ejs', { id: 'add_plano-duracao' , type: 'number' ,
              icon: 'fi fi-rs-calendar-clock' , placeholder: 'Duração em meses' }) %>
              <div id="bg_add_plano-duracao" class="flex flex-col w-full">
                <label class="max-xs:text-xs max-sm:text-sm" for="add_plano-duracao">
                  Duração em meses
                  <span class="text-xs text-red-500 font-medium opacity-0">test</span>
                </label>
                <div class="relative flex items-center mb-1">
                  <i class="fi fi-rs-calendar-clock text-xl absolute translate-x-1/2 flex z-[1]"></i>
                  <select name="add_plano-duracao" id="add_plano-duracao" 
                  class="w-full max-xs:text-xs max-sm:text-sm drop-shadow-sm focus:drop-shadow focus:outline-none bg-zinc-50 dark:bg-zinc-700 p-1 pl-10 border-[1px] border-zinc-100 dark:border-zinc-600 rounded bg-transparent flex" required>
                    <option value="1" selected>1 Mês</option>
                    <option value="3">3 Meses</option>
                    <!-- <option value="6">6 Meses</option> -->
                    <option value="12">12 Meses</option>
                  </select>
                </div>
              </div>
              <%- include('../includes/dashboard/components/input_text.ejs', { id: 'add_plano-valor' ,
                icon: 'fi fi-rs-money-check-edit' , placeholder: 'Valor' , value: '0,00' , myclass: 'valores' }) %>
                <%- include('../includes/dashboard/components/input_text.ejs', { id: 'add_plano-desconto' ,
                  icon: 'fi fi-rs-money-check-edit' , placeholder: 'Desconto' , value: '0,00' , myclass: 'valores' }) %>
                  <div class="mygrid bg-zinc-50 dark:bg-zinc-700 p-1 rounded dark:shadow-zinc-300 mb-1">
                    <div class="flex gap-1 items-center relative">
                      <%- include('../includes/dashboard/components/checkbox.ejs', {verify: false, id: 'add_plano-site'
                        , classes: 'services_check' }) %>
                        <span class="text-nowrap max-xs:text-xs max-sm:text-sm">Incluir agendamento no site</span>
                    </div>
                  </div>
                  <div class="mygrid bg-zinc-50 dark:bg-zinc-700 p-1 rounded dark:shadow-zinc-300 mb-1">
                    <div class="flex gap-1 items-center relative">
                      <%- include('../includes/dashboard/components/checkbox.ejs', {verify: false,
                        id: 'add_plano-chatbot' , classes: 'services_check' }) %>
                        <span class="text-nowrap max-xs:text-xs max-sm:text-sm">Incluir agendamento via ChatBot</span>
                    </div>
                  </div>
                  <input type="hidden" name="plano_id" id="plano_id">
      </div>


      <div class="w-full flex items-center gap-2 mt-3">
        <button id="cancelar_add_plano" type="button" onclick="toggleAddPlano(true)"
          class="px-0.5 sm:px-1 py-px flex justify-center items-center rounded-sm bg-zinc-600 hover:bg-zinc-500 text-white w-full">
          <i class="fi fi-br-x mr-1 sm:text-xl flex transition-all duration-1000 transform text-red-500"></i>
          Cancelar
        </button>
        <button type="submit"
          class="px-0.5 sm:px-1 py-px flex justify-center items-center rounded-sm bg-zinc-600 hover:bg-zinc-500 text-white w-full">
          <i class="fi fi-br-check mr-1 sm:text-xl flex transition-all duration-1000 transform text-green-500"></i>
          Salvar
        </button>
      </div>
    </div>
  </div>
  <script>
    
    // adicionar evento de input para formatar o valor
    $(document).ready(function () {
      $('.valores').on('input change', function (e) {
        console.log('valores input');
        let val = e.target.value;
        // remover caracteres que não são numeros
        val = val.replace(/\D/g, '');
        // adicionar a mascara de dinheiro
        e.target.value = 'R$ ' + (new Intl.NumberFormat('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 }).format(val / 100));
      });
    });
    let add_plano = true;
    function toggleAddPlano(close = Boolean, add) {
      add_plano = add ? true : false
      if (!close) {
        if (add) {
          $('#plano_id').val('')
          $('#add_plano-title').text('Adicionar Plano')
          // definir os checkbox como true
          $('#add_plano-site').prop('checked', true)
          $('#add_plano-chatbot').prop('checked', false)
        } else {
          $('#add_plano-title').text('Editar Plano')
        }
        $('#add_plano-bg').toggleClass('hidden flex')
        // setTimeout(() => {
        $('#add_plano-valor').trigger('input')
        $('#add_plano-desconto').trigger('input')
        // }, 2000);
        return
      }
      $('#add_plano-nome').val('');
      $('#add_plano-descricao').val('');
      $('#add_plano-duracao').val('1');
      $('#add_plano-valor').val('0,00');
      $('#add_plano-desconto').val('0,00');


      $('#add_plano-bg').find('.animate-slideBottomToTop').toggleClass('animate-slideBottomToTop animate-slideTopToBottom')
      setTimeout(() => {
        $('#add_plano-bg').find('.animate-slideTopToBottom').toggleClass('animate-slideBottomToTop animate-slideTopToBottom')
        if (close) $('#add_plano-bg').toggleClass('hidden flex')
      }, 500);
    }

  </script>

</form>

<div class="container mx-auto my-3">
  <!-- <h1 class="mb-4 text-center text-2xl font-bold">Clientes</h1> -->
  <h1 class="mb-2 font-bold w-full text-center relative text-2xl font-mono flex items-center justify-center">
    Planos

    <div class="absolute right-0">
      <div onclick="toggleAddPlano(false, true)"
        class="shadow-sm shadow-green-600 hover:shadow-green-700 cursor-pointer group relative bg-green-500 hover:bg-green-600 flex items-center px-2 py-1 rounded-[1px] transition-all duration-300 overflow-hidden">
        <span class="mr-8 text-zinc-200 font-semibold max-xss:text-xs">Add</span>
        <i
          class="text-white transition-all duration-300 group-hover:rotate-180 group-hover:w-full w-8 absolute fi fi-rr-plus bg-green-600 h-full right-0 flex items-center justify-center px-1"></i>
      </div>
    </div>

  </h1>



  <div class="table-wrapper table-responsive">
    <!-- <div class="overflow-auto"> -->
    <table id="datatablePlanos" style="width: 100%;"
      class="text-gray-400 border-separate space-y-6 text-sm table display responsive nowrap dataTable no-footer dtr-inline collapsed">
      <thead class="bg-zinc-700 text-white">
        <tr>
          <th class="p-3">ID</th>
          <th class="p-3 text-center">Nome</th>
          <th class="p-3 text-center">Descrição</th>
          <th class="p-3 text-center">Duração</th>
          <th class="p-3 text-center">Valor</th>
          <th class="p-3 text-center">Desconto</th>
          <th class="p-3 text-center">Site</th>
          <th class="p-3 text-center">ChatBot</th>
          <th class="p-3 text-center">Ações</th>
        </tr>
      </thead>
      <tbody id="planosTable">
        <% planos.forEach(plano=> { %>
          <tr id="planoColumn_<%= plano.id %>" class="bg-zinc-50 dark:bg-zinc-900 text-black dark:text-white">
            <td class="p-3 text-center font-medium">
              <%= plano.id %>
            </td>
            <td class="p-3 text-center font-medium">
              <%= plano.nome %>
            </td>
            <td class="p-3 text-center font-medium">
              <span class="truncate" title="<%= plano.descricao %>">
                <%= plano.descricao.length> 30 ? plano.descricao.substring(0, 30) + '...' : plano.descricao %>
              </span>
            </td>
            <td class="p-3 text-center font-medium">
              <span title="<%= plano.duracao === 1 ? plano.duracao+' Mês' : plano.duracao+' Meses' %>">
                <%= plano.duracao %>
              </span>
            </td>
            <td class="p-3 text-center font-medium capitalize">
              R$ <%= new Intl.NumberFormat('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2
                }).format(parseFloat(plano.valor)) %>
            </td>
            <td class="p-3 text-center font-medium">
              R$ <%= new Intl.NumberFormat('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2
                }).format(parseFloat(plano.desconto || 0)) %>
            </td>
            <td class="p-3 text-center font-medium">
              <div class=" flex items-center justify-center gap-1">
                <div class="w-2 h-2 flex rounded-full bg-<%= plano.sistema ? 'green' : 'red' %>-500"></div>
                <span class="text-<%= plano.sistema ? 'green' : 'red' %>-500"><%= plano.sistema ? 'Sim' : 'Não' %></span>
              </div>
            </td>
            <td class="p-3 text-center font-medium">
              <div class=" flex items-center justify-center gap-1">
                <div class="w-2 h-2 flex rounded-full bg-<%= plano.chatbot ? 'green' : 'red' %>-500"></div>
                <span class="text-<%= plano.chatbot ? 'green' : 'red' %>-500"><%= plano.chatbot ? 'Sim' : 'Não' %></span>
              </div>
            </td>
            <td class="p-3 text-center">
              <div class="flex justify-center gap-1">
                <button id="edit_<%= plano.id %>" onclick="edit_plano(<%= JSON.stringify(plano) %>)"
                  class="px-0.5 sm:px-1 py-px flex justify-center items-center rounded-sm bg-zinc-600 hover:bg-zinc-500 text-white relative group">
                  <i class="fi fi-rs-gears flex text-2xl"></i>
                  <span
                    class="absolute z-1 pointer-events-none bg-zinc-600 text-white rounded-sm opacity-0 group-hover:opacity-100 translate-y-0 group-hover:-translate-y-full duration-400 transition-all transform px-1">
                    Editar</span>
                </button>
                <button id="delete_<%= plano.id %>" onclick="delete_plano(<%= plano.id %>)"
                  class="px-0.5 sm:px-1 py-px flex justify-center items-center rounded-sm bg-red-600 hover:bg-red-500 text-white relative group">
                  <i class="fi fi-sr-trash-xmark flex text-2xl"></i>
                  <span
                    class="absolute z-1 pointer-events-none bg-red-500 text-white rounded-sm opacity-0 group-hover:opacity-100 translate-y-0 group-hover:-translate-y-full duration-400 transition-all transform px-1">
                    Excluir</span>
                </button>
              </div>
            </td>
          </tr>
          <% }) %>
      </tbody>
    </table>
  </div>
</div>

<link rel="stylesheet" type="text/css"
  href="https://cdn.datatables.net/responsive/2.2.9/css/responsive.dataTables.min.css">
  
  <%- include('../includes/script_tables/js.ejs') %>

<script>

async function handle_plano(event) {
      event.preventDefault()
      const converterParaMoeada = (valor) => {
        return Number(parseFloat(valor.replace(/\D/g, '') / 100).toFixed(2))
      }
      
      const id = Number($('#plano_id').val());
      let body = {
        nome: $('#add_plano-nome').val(),
        descricao: $('#add_plano-descricao').val(),
        duracao: Number($('#add_plano-duracao').val()),
        valor: converterParaMoeada($('#add_plano-valor').val()),
        desconto: converterParaMoeada($('#add_plano-desconto').val()),
        site: $('#add_plano-site').prop('checked'),
        chatbot: $('#add_plano-chatbot').prop('checked'),
        id
      }
      if (body.valor < 5) {
        aToast('O valor do plano deve ser maior que R$ 4,99', {
          type: 'warning',
          progress: true,
        })
        return
      }
      // console.log(body)
      // return
      const req = await requestPost('/v1/superadmin/dashboard/handle_plano', body)
      console.log('req:', req)
      if (req?.success) {
        aToast(req.message, {
          type: 'success',
          progress: true,
        })
        toggleAddPlano(true)
        setTimeout(() => {
          window.location.reload()
        }, 2000);
        // if (id) {
        //   const tr = $(`#planoColumn_${id}`)
        //   tr.find('td').eq(1).text(body.nome)
        //   tr.find('td').eq(2).text(body.descricao)
        //   tr.find('td').eq(3).text(body.duracao)
        //   tr.find('td').eq(4).text(`R$ ${new Intl.NumberFormat('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 }).format(body.valor)}`)
        //   tr.find('td').eq(5).text(`R$ ${new Intl.NumberFormat('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 }).format(body.desconto)}`)
        //   tr.find('td').eq(6).html(`<div class=" flex items-center justify-center gap-1"><div class="w-3 h-3 flex rounded-full bg-${body.site ? 'green' : 'red'}-500"></div>${body.site ? 'Sim' : 'Não'}</div>`)
        //   tr.find('td').eq(7).html(`<div class=" flex items-center justify-center gap-1"><div class="w-3 h-3 flex rounded-full bg-${body.chatbot ? 'green' : 'red'}-500"></div>${body.chatbot ? 'Sim' : 'Não'}</div>`)
        //   return
        // }
        // let tr = document.createElement('tr');
        // tr.id = `planoColumn_${req.id}`;
        // tr.classList.add('bg-zinc-50', 'dark:bg-zinc-900', 'text-black', 'dark:text-white');
        // tr.appendChild(createTd(body.id, 'p-3 text-center font-medium'));
        // tr.appendChild(createTd(body.nome, 'p-3 text-center font-medium'));
        // tr.appendChild(createTd(body.descricao, 'p-3 text-center font-medium'));
        // tr.appendChild(createTd(body.duracao, 'p-3 text-center font-medium'));
        // tr.appendChild(createTd(`R$ ${new Intl.NumberFormat('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 }).format(body.valor)}`, 'p-3 text-center font-medium'));
        // tr.appendChild(createTd(`R$ ${new Intl.NumberFormat('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 }).format(body.desconto)}`, 'p-3 text-center font-medium'));
        // tr.appendChild(createTd(`<div class=" flex items-center justify-center gap-1"><div class="w-3 h-3 flex rounded-full bg-${body.site ? 'green' : 'red'}-500"></div>${body.site ? 'Sim' : 'Não'}</div>`, 'p-3 text-center font-medium'));
        // tr.appendChild(createTd(`<div class=" flex items-center justify-center gap-1"><div class="w-3 h-3 flex rounded-full bg-${body.chatbot ? 'green' : 'red'}-500"></div>${body.chatbot ? 'Sim' : 'Não'}</div>`, 'p-3 text-center font-medium'));
        // tr.appendChild(createTd(`<div class="flex justify-center gap-1"><button id="edit_${body.id}" onclick="edit_plano(${JSON.stringify(body)})" class="px-0.5 sm:px-1 py-px flex justify-center items-center rounded-sm bg-zinc-600 hover:bg-zinc-500 text-white relative group"><i class="fi fi-rs-gears flex text-2xl"></i><span class="absolute z-1 pointer-events-none bg-zinc-600 text-white rounded-sm opacity-0 group-hover:opacity-100 translate-y-0 group-hover:-translate-y-full duration-400 transition-all transform px-1">Editar</span></button><button id="delete_${body.id}" onclick="delete_plano(${body.id})" class="px-0.5 sm:px-1 py-px flex justify-center items-center rounded-sm bg-red-600 hover:bg-red-500 text-white relative group"><i class="fi fi-sr-trash-xmark flex text-2xl"></i><span class="absolute z-1 pointer-events-none bg-red-500 text-white rounded-sm opacity-0 group-hover:opacity-100 translate-y-0 group-hover:-translate-y-full duration-400 transition-all transform px-1">Excluir</span></button></div></td>`, 'p-3 text-center'));
        // $('#planosTable').append(tr)
        return
      }
      aToast(req.message, {
        type: 'error',
        progress: true,
      })      
    }
    
  function edit_plano(data) {
    const { id, nome, descricao, duracao, valor, desconto, sistema, chatbot } = data
    $('#add_plano-nome').val(nome);
    $('#add_plano-descricao').val(descricao);
    $('#add_plano-duracao').val(duracao);
    $('#add_plano-valor').val((parseFloat(valor) || 0).toFixed(2));
    $('#add_plano-desconto').val((parseFloat(desconto) || 0).toFixed(2));
    $('#add_plano-site').prop('checked', sistema)
    $('#add_plano-chatbot').prop('checked', chatbot)
    // add o id do plano
    $('#plano_id').val(id)
    toggleAddPlano(false, false)
  }
  async function delete_plano(id) {
    let confirm = await showConfirm('Tem certeza que deseja deletar este plano, sera excluido todos as faturas referentes a ele', { type: 'error', btn_yes: 'Deletar', btn_no: 'Cancelar' })
    if (!confirm) {
      return
    }
    let body = {
      id_plano: id
    }
    // console.log(body)
    // return
    const req = await requestPost('/v1/superadmin/dashboard/delete_plano', body)
    console.log('req:', req)
    if (req?.success) {
      $(`#delete_${id}`).closest('tr').remove()
      aToast(req.message, {
        type: 'success',
        progress: true,
      })
      return
    }
  }

</script>
<script>
  $(function () {
    'use strict';

    $('#datatablePlanos').DataTable({
      "order": [[3, "asc"]],
      responsive: true,
      language: {
        searchPlaceholder: 'Buscar...',
        sSearch: '',
        lengthMenu: '_MENU_ ítens',
      }
    });

    // Select2
    $('.dataTables_length select').select2({ minimumResultsForSearch: Infinity });
  });
</script>