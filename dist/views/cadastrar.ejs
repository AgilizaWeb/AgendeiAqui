<!DOCTYPE html>
<html lang="pt-br">
    <% const dominio = `https://${typeof superAdmin !== 'undefined' && superAdmin.domain ? superAdmin.domain : 'agendeiaqui.com'}` %>

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cadastro - Sistema de Agendamento</title>

    <link rel="stylesheet" type="text/css" href="../css/utils/input.css">
    <link rel="stylesheet" type="text/css" href="../css/utils/form.css">
    <link rel="stylesheet" type="text/css" href="../css/utils/switch.css">
    <link rel="stylesheet" type="text/css" href="../css/utils/card.css">
    <link rel="stylesheet" type="text/css" href="../css/utils/animations.css">
    <link rel="stylesheet" type="text/css" href="../css/utils/utils.css">

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">

    <meta property="og:image" content="<%= dominio %>/icons/logo.png">

    <meta property="og:url" content="<%= dominio %>/cadastro" />
    <meta property="og:type" content="website">
    
    
    <link rel="shortcut icon" type="image/png" href="<%= dominio %>/icons/logo.png">
    <link rel="apple-touch-icon" href="<%= dominio %>/icons/logo.png">
    

    <link rel="stylesheet" type="text/css"
        href="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/css/toastr.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/js/toastr.min.js"></script>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Roboto:ital,wght@0,100;0,300;0,400;0,500;0,700;0,900;1,100;1,300;1,400;1,500;1,700;1,900&display=swap"
        rel="stylesheet">

    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #09090b;

            font-family: 'Roboto', sans-serif;
            font-style: normal;
            font-weight: 600;
        }
    </style>
</head>

<body>

    <div class="displayCenter fullScreen">

        <div class="formBG">
            <div class="header">
                <img style="cursor: pointer;" onclick="window.location.href = '/'" src="../icons/logo.png" alt="Logo">
                <h2>Cadastrar</h2>
            </div>
            <form class="form"  onsubmit="cadastrar(event)" method="post">
                <div class="input-icon">
                    <i class="bi bi-building"></i>
                    <input type="text" id="empresa" name="empresa" placeholder="Nome da empresa" required>
                </div>
                <div id="marginSub"></div>
                <div class="input-icon">
                    <i class="bi bi-globe"></i>
                    <input style="padding-right: 130px;" type="text" id="subdomain" maxlength="40" name="subdomain"
                        placeholder="Link" required>
                    <span class="subdomainExample">.<%= superAdmin.domain %></span>
                    <span class="result"></span>
                </div>
                <div class="input-icon">
                    <i class="bi bi-person-fill"></i>
                    <input type="text" id="user" name="user" placeholder="Seu nome" required>
                </div>
                <div class="input-icon">
                    <i class="bi bi-whatsapp"></i>
                    <input type="text" id="whatsapp" name="whatsapp" placeholder="Whatsapp" required>
                </div>
                <div class="input-icon">
                    <i class="bi bi-envelope-at-fill"></i>
                    <input type="text" id="email" name="email" placeholder="E-mail" required>
                </div>
                <div class="input-icon">
                    <i class="bi bi-lock-fill"></i>
                    <input type="password" id="password" name="password" placeholder="Senha" required>
                </div>
                <div class="input-icon">
                    <i class="bi bi-lock-fill"></i>
                    <input type="password" id="confirm_password" name="confirm_password" placeholder="Confirmar senha"
                        required>
                </div>
                <div class="input-icon" style="margin-bottom: 0px;">
                    <i class="bi bi-123"></i>
                    <!-- <i class="bi bi-person-raised-hand"></i> -->
                    <!-- <i class="bi bi-person-check-fill"></i> -->
                    <input type="text" id="codigo_afiliado" name="codigo_afiliado" placeholder="Código de indicação">
                </div>
                <p style="margin: 0;" id="notify"></p>
                <div class="fullH hRight">
                    <a class="forgot" href="/login"><i class="bi bi-person"></i> Já tenho uma conta</a>
                </div>
                <div class="fullH hCenter">
                    <button class="buttonGreen" type="submit"><i class="bi bi-door-open"></i>Cadastrar</button>
                </div>

            </form>

        </div>

    </div>

</body>

</html>

<script src="../js/utils.js"></script>


<script>
    localStorage.removeItem('codigoAfiliado')
    let codigoAfiliado = localStorage.getItem('codigoAfiliado')
    if (!codigoAfiliado) {
        console.log('codigoAfiliado não encontrado no localStorage');
        // obter o query string da URL
        const queryString = window.location.search;
        // Criar um objeto URLSearchParams a partir da query string
        const urlParams = new URLSearchParams(queryString);
        // Obter o valor do parâmetro 'afiliado' da URL
        codigoAfiliado = urlParams.get('afiliado') || '';
        // Salvar o valor do parâmetro 'afiliado' no localStorage
        localStorage.setItem('codigoAfiliado', codigoAfiliado);
    }
    const codigo_afiliado = getID('codigo_afiliado')
    if (codigoAfiliado) {
        codigo_afiliado.value = codigoAfiliado
        // definir input como readonly
        codigo_afiliado.setAttribute('readonly', true)
    }
    console.log('codigoAfiliado:', codigoAfiliado);
    getID('subdomain').addEventListener('focus', function () {
        if (getID('subdomain').value) getID('marginSub').style.marginTop = '40px'
    });

    getID('subdomain').addEventListener('blur', function () {
        getID('marginSub').style.marginTop = '0px'
    });
    // Adiciona um listener para o evento 'input' no campo de subdomínio
    getID('subdomain').addEventListener('input', function () {
        // Obtém o valor do subdomínio
        var subdomain = getID('subdomain')
        let result = document.querySelector('.formBG .result')
        if (subdomain.value) {
            getID('marginSub').style.marginTop = '40px'
            result.style.display = 'block'
        } else {
            result.style.display = 'none'
            
        }

        subdomain.value = subdomain.value.replace(/[^a-zA-Z0-9\-_]/g, '').toLocaleLowerCase();
        result.textContent = subdomain.value + document.querySelector('.formBG .subdomainExample').textContent
    });

    // document.addEventListener('keydown', function (event) {
    //     if (event.key === "Enter") {
    //         cadastrar(event);
    //     }
    // });

    getID('confirm_password').addEventListener('input', function () {
        const confir = getID('confirm_password').value
        const notify = getID('notify')
        if (!confir) {
            notify.textContent = ''
            return
        }

        if (getID('password').value !== confir) {
            notify.style.color = 'red'
            notify.textContent = 'Invalida!'
            return
        }
        notify.style.color = 'green'
        notify.textContent = 'Correta!'

    });
    async function cadastrar(event) {
        event.preventDefault();
        let user = getID('user').value
        let email = getID('email').value
        let whatsapp = getID('whatsapp').value
        let password = getID('password').value
        let confirm_password = getID('confirm_password').value
        let subdomain = getID('subdomain').value
        let empresa = getID('empresa').value

        if (!email) {
            toastr.warning('Insira o e-mail')
        }else if (!user) {
            toastr.warning('Insira o nome do usuario')
        }else if (!whatsapp) {
            toastr.warning('Insira o numero do whatsapp')
        }else if (!password) {
            toastr.warning('Insira a senha de acesso!')
        }else if (!confirm_password) {
            toastr.warning('Insira a senha de acesso!')
        }else if (password !== confirm_password) {
            toastr.warning('Senhas incorretas')
        }else if (!subdomain) {
            toastr.warning('Insira o subdominio!')
        }else if (password !== confirm_password) {
            toastr.warning('Insira o nome da empresa!')
        }

        codigoAfiliado = codigo_afiliado.value
        // console.log('body:', { empresa, subdomain, user, whatsapp, email, password, confirm_password, codigoAfiliado });
        // return
        let res = await requestPost('/cadastro', { 
            empresa, subdomain, user, whatsapp, email, password, confirm_password, codigoAfiliado
         })
        if (res.success) {
            toastr.success(res.res)
            setTimeout(() => {
                window.location.href = '/login'
            }, 2000);
        } else {
            toastr.error(res.res)
        }
    }

    $('#codigo_afiliado').on('input change', function () {
        // Obtém o valor atual do campo de entrada
        let valorAtual = $(this).val();
        // Remove todos os espaços em branco
        let replaced = valorAtual.replace(/ /g, '');
        $(this).val(replaced);
    });
  // Inicializa o valor formatado anterior como uma string vazia
  let valorFormatadoAnteriorWhatsapp = '';
  $('#whatsapp').on('input change', function () {
    // Obtém o valor atual do campo de entrada
    let valorAtual = $(this).val();
    // Remove qualquer caractere que não seja um dígito numérico
    let valorNumerico = valorAtual.replace(/\D/g, '');
    // Aplica a formatação de telefone: 55 (11) 90011-2233
    let valorFormatado = formatPhoneNumber(valorNumerico);

    // Atualiza o campo de entrada com o valor formatado apenas se for diferente do valor anterior
    // Isso impede que a formatação interfira na remoção de caracteres
    if (valorFormatado !== valorFormatadoAnteriorWhatsapp) {
      $(this).val(valorFormatado);
      // Atualiza o valor formatado anterior
      valorFormatadoAnteriorWhatsapp = valorFormatado;
    }
  });
</script>