<style>
  .mygrid {
    gap: 4px;
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(50px, 1fr));
  }
</style>
<form onsubmit="salvarHome(event)" class="p-1 w-full h-full flex justify-center items-center flex-col">
  <div class="flex items-center flex-col max-sm:w-full sm:w-[60%]">
    <img id="logo_prev_id" class="w-28 mb-2" src="<%= empresa.logo %>" alt="Logo da empresa">
    <div class="mb-4">
      <label for="logo_upload_id"
        class="text-white text-center flex items-center px-4 py-1 rounded-sm cursor-pointer bg-blue-500 hover:bg-blue-600">
        <i class="fi fi-br-picture mr-1 flex text-green-500"></i>Definir logo da empresa
      </label>
      <input id="logo_upload_id" type="file" accept="image/*" class="hidden">
    </div>

    <%- include('./components/input_text.ejs', { id: 'empresa_id' , icon: 'fi fi-rs-blog-pencil' , placeholder: 'Nome da empresa'
      , value: empresa.empresa }) %>
      <%- include('./components/input_subdomain.ejs', { id: 'subdomain_id' , icon: 'bi bi-globe' ,
        placeholder: 'Subdominio da empresa' , value: empresa.subdomain }) %>
  </div>
  <div class="mt-5 w-full">
    <div class="drop-shadow w-full flex flex-col items-center relative overflow-hidden">
      <div onclick="openHorariosEmpresa(this)"
        class="z-[1] max-sm:w-full sm:w-[60%] px-2 py-1 rounded-tl rounded-tr flex justify-between items-center bg-zinc-100 dark:bg-zinc-600 cursor-pointer">
        <h1 class="flex items-center text-zinc-500 dark:text-zinc-300 max-xs:text-xs max-sm:text-sm"><span
            class="fi fi-bs-calendar-clock mr-2 flex dark:text-white text-black"></span>Definir horarios de atendimento</h1>
        <i class="fi fi-br-angle-double-right flex transition-all transform duration-1000 ease-in-out"></i>
      </div>
      <div id="horarios_empresa_id"
        class="flex max-sm:w-full sm:w-[60%] transition-all transform duration-1000 ease-in-out opacity-0 max-h-0 translate-y-[-100%] px-2 flex-col justify-between items-center bg-zinc-50 dark:bg-zinc-500">
        <div class="w-full mygrid border-b border-black dark:border-white">

          <div class="flex gap-1 items-center justify-center">
            <i class="fi fi-br-calendar-day flex"></i>
            <span>Dia</span>
          </div>

          <div class="flex gap-1 items-center justify-center">
            <i class="fi fi-br-time-check flex"></i>
            <span>Aberto</span>
          </div>

          <div class="flex gap-1 items-center justify-center">
            <i class="fi fi-br-brightness flex text-yellow-500"></i>
            <span>Inicio</span>
          </div>

          <div class="flex gap-1 items-center justify-center">
            <i class="fi fi-br-moon-stars flex text-blue-500"></i>
            <span>Fim</span>
          </div>

        </div>
        <% for (const dia in empresa.atendimento) { %>
          <%- include('./components/horario_dia.ejs', { name: dia , disponivel: empresa.atendimento[dia].disponivel,
            open: empresa.atendimento[dia].open, close: empresa.atendimento[dia].close, }) %>
            <% } %>
      </div>
    </div>
    <div class="w-full flex justify-center mt-4">
      <button class="app_buttons bg-green-500 hover:bg-green-600 text-white" type="submit">
        <i class="fi fi-rr-disk"></i>
        Salvar alterações
      </button>
    </div>


  </div>
</form>
<script>
  let newLogo = false
  function salvarHome(event) {
    if (event) event.preventDefault();
    // let logo = newLogo ? $('#logo_prev_id').attr('src') : ''
    let empresa = $('#empresa_id').val()
    let subdomain = $('#subdomain_id').val()
    console.log('diso_seg:', $('#seg_inicio_id').val())
    let atendimento = JSON.stringify({
      seg: {
        disponivel: $('#seg_aberto_id').is(':checked') ? true : false,
        open: $('#seg_inicio_id').val(),
        close: $('#seg_fim_id').val()
      },
      ter: {
        disponivel: $('#ter_aberto_id').is(':checked') ? true : false,
        open: $('#ter_inicio_id').val(),
        close: $('#ter_fim_id').val()
      },
      qua: {
        disponivel: $('#qua_aberto_id').is(':checked') ? true : false,
        open: $('#qua_inicio_id').val(),
        close: $('#qua_fim_id').val()
      },
      qui: {
        disponivel: $('#qui_aberto_id').is(':checked') ? true : false,
        open: $('#qui_inicio_id').val(),
        close: $('#qui_fim_id').val()
      },
      sex: {
        disponivel: $('#sex_aberto_id').is(':checked') ? true : false,
        open: $('#sex_inicio_id').val(),
        close: $('#sex_fim_id').val()
      },
      sab: {
        disponivel: $('#sab_aberto_id').is(':checked') ? true : false,
        open: $('#sab_inicio_id').val(),
        close: $('#sab_fim_id').val()
      },
      dom: {
        disponivel: $('#dom_aberto_id').is(':checked') ? true : false,
        open: $('#dom_inicio_id').val(),
        close: $('#dom_fim_id').val()
      }
    })

    console.log('atendimento:', atendimento)
    // console.log(logo, empresa, subdomain)
    $.post('/v1/setempresa', {
      empresa,
      subdomain,
      atendimento,
      logo: newLogo ? $('#logo_prev_id').attr('src') : ''
    }, function (response) {

      if (response.success) {
        toastr.success(response.message)
        return
      }
      toastr.warning(response.message)

    }, 'json').fail(function (xhr, status, error) {

      let response = xhr.responseJSON
      toastr.success(response.message)
      console.error('Erro na requisição:', error, xhr.responseJSON);

    });

  }
  $('#logo_upload_id').change(function () {
    var file = this.files[0];
    if (file) {
      var reader = new FileReader();
      reader.onload = function (e) {
        let r = e.target.result
        // console.log('result_img:', r)
        newLogo = true;
        $('#logo_prev_id').attr('src', r);
      };
      reader.readAsDataURL(file);
    }
  });
  function openHorariosEmpresa(e) {
    $(e).find('i').toggleClass('rotate-90')
    $('#horarios_empresa_id').toggleClass('opacity-0 max-h-0 max-h-full translate-y-[-100%]')
  }
</script>